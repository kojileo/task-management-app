name: Backend PR Pipeline

on:
  pull_request:
    branches:
      - develop
    paths:
      - 'backend/**'
      - '.github/workflows/backend-pr.yml'

jobs:
  backend-pr-checks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: task-management-app

      - name: Debug directory structure
        run: |
          echo "Current directory: $(pwd)"
          echo "Listing root directory:"
          ls -la
          echo "Listing task-management-app directory:"
          ls -la task-management-app
          echo "Listing backend directory:"
          ls -la task-management-app/backend

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        working-directory: task-management-app/backend
        run: |
          echo "Current directory: $(pwd)"
          echo "Listing current directory:"
          ls -la
          dotnet restore

      - name: Build with StyleCop
        working-directory: task-management-app/backend
        run: dotnet build /p:TreatWarningsAsErrors=true

      - name: Security scan
        working-directory: task-management-app/backend
        run: dotnet list package --vulnerable

      - name: Run unit tests with coverage
        working-directory: task-management-app/backend
        run: |
          dotnet test TaskManagement.Tests/TaskManagement.Tests.csproj --collect:"XPlat Code Coverage" --filter "Category=Unit"
          if [ $? -ne 0 ]; then
            echo "Unit tests failed"
            exit 1
          fi

      - name: Run integration tests with coverage
        working-directory: task-management-app/backend
        run: |
          dotnet test TaskManagement.Tests/TaskManagement.Tests.csproj --collect:"XPlat Code Coverage" --filter "Category=Integration"
          if [ $? -ne 0 ]; then
            echo "Integration tests failed"
            exit 1
          fi

      - name: Check coverage thresholds
        working-directory: task-management-app/backend
        run: |
          # ユニットテストのカバレッジチェック
          if [ $(grep -o '"lineRate": [0-9]*\.[0-9]*' coverage/unit/coverage.cobertura.xml | grep -o '[0-9]*\.[0-9]*' | awk '{print int($1 * 100)}') -lt 85 ]; then
            echo "Unit test line coverage is below 85%"
            exit 1
          fi
          if [ $(grep -o '"branchRate": [0-9]*\.[0-9]*' coverage/unit/coverage.cobertura.xml | grep -o '[0-9]*\.[0-9]*' | awk '{print int($1 * 100)}') -lt 75 ]; then
            echo "Unit test branch coverage is below 75%"
            exit 1
          fi

          # インテグレーションテストのカバレッジチェック
          if [ $(grep -o '"lineRate": [0-9]*\.[0-9]*' coverage/integration/coverage.cobertura.xml | grep -o '[0-9]*\.[0-9]*' | awk '{print int($1 * 100)}') -lt 60 ]; then
            echo "Integration test line coverage is below 60%"
            exit 1
          fi
          if [ $(grep -o '"branchRate": [0-9]*\.[0-9]*' coverage/integration/coverage.cobertura.xml | grep -o '[0-9]*\.[0-9]*' | awk '{print int($1 * 100)}') -lt 50 ]; then
            echo "Integration test branch coverage is below 50%"
            exit 1
          fi

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage-reports
          path: |
            task-management-app/backend/coverage/unit
            task-management-app/backend/coverage/integration
          retention-days: 7 